---
title: "Netlogo_output_anaylsis"
author: "Veronika Juhasz"
date: "5/20/2021"
output: html_document
---

---
title: "Untitled"
author: "Veronika Juhasz"
date: "5/19/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

pacman::p_load(tidyverse, dplyr, pastecs, WRS2)
library("ggpubr")

setwd("/Users/veronikajuhasz/Documents/University/Cognitive_science_AU/Semester_4/Soc_cult/exam/ABM_code final running-2")

getwd()


```



to-dos:
- read in dataframes - DONE
- remove unneccessary rows (top section) - DONE
- leave only 1 ticks column, remove the rest - DONE
- rename column headers - DONE
- remove ticks over 2920 - DONE
- remove duplicates (keep every 10th row) - DONE
- make aggregate data per condition (sum the 10 trials per condition) - DONE
- compare conditions 

```{r}


data.preprocessing <- function(dat) {
  dat %>% 
  select(
     ticks = x,
     mean_opinion_global = y,
     var_opinion_global = y.1,
     sd_opinion_global = y.2,
     mean_opinion_group_1 = y.3,
     var_opinion_group_1 = y.4,
     sd_opinion_group_1 = y.5,
     mean_opinion_group_0 = y.6,
     var_opinion_group_0 = y.7,
     sd_opinion_group_0 = y.8,
     mean_opinion_group_neg1 = y.9,
     var_opinion_group_neg1 = y.10,
     sd_opinion_group_neg1= y.11, 
     mean_opinion_left = y.12,
     var_opinion_left= y.13,
     sd_opinion_left= y.14,
     mean_opinion_mid_left= y.15,
     var_opinion_mid_left = y.16,
     sd_opinion_mid_left = y.17,
     mean_opinion_middle = y.18,
     var_opinion_middle = y.19,
     sd_opinion_middle = y.20,
     mean_opinion_mid_right= y.21,
     var_opinion_mid_right= y.22,
     sd_opinion_mid_right= y.23,
     mean_opinion_right = y.24,
     var_opinion_right = y.25,
     sd_opinion_right = y.26,
     polarization_index = y.27,
     percent_extremists= y.28,
     percent_extremists_1= y.29,
     percent_extremists_neg1= y.30,
     file_id) %>% 
  filter(
      ticks < 2921,
      row_number() %% 10 == 1) %>% 
  mutate(
    trial = str_extract(file_id, "[^_]+$"),
    trial = str_extract(trial, ".*(?=\\.csv)")
  )
}

```



Reading in condition 1

```{r}

files_cond1 <- list.files(".", pattern = "^exam_v15 Super combined plot_cond1.*?\\.csv", full.names = TRUE, recursive = T)

df_cond1 <- purrr::map_df(files_cond1, function(x) {
	data <- read.csv(x, skip = 46, header=TRUE)
	cbind(file_id = x, data)
	})

df_preprocessed_cond1 <- df_cond1 %>% 
  data.preprocessing() %>% 
  mutate(
    condition = "cond1"
  )

```

Reading in condition 2

```{r}

files_cond2 <- list.files(".", pattern = "^exam_v15 Super combined plot_cond2.*?\\.csv", full.names = TRUE, recursive = T)

df_cond2 <- purrr::map_df(files_cond2, function(x) {
	data <- read.csv(x, skip = 46, header=TRUE)
	cbind(file_id = x, data)
	})

df_preprocessed_cond2 <- df_cond2 %>% 
  data.preprocessing() %>% 
  mutate(
    condition = "cond2"
  )

```


Reading in condition 3

```{r}

files_cond3 <- list.files(".", pattern = "^exam_v15 Super combined plot_cond3.*?\\.csv", full.names = TRUE, recursive = T)

df_cond3 <- purrr::map_df(files_cond3, function(x) {
	data <- read.csv(x, skip = 46, header=TRUE)
	cbind(file_id = x, data)
	})

df_preprocessed_cond3 <- df_cond3 %>% 
  data.preprocessing() %>% 
  mutate(
    condition = "cond3"
  )

```


Reading in condition 4

```{r}

files_cond4 <- list.files(".", pattern = "^exam_v15 Super combined plot_cond4.*?\\.csv", full.names = TRUE, recursive = T)

df_cond4 <- purrr::map_df(files_cond4, function(x) {
	data <- read.csv(x, skip = 46, header=TRUE)
	cbind(file_id = x, data)
	})

df_preprocessed_cond4 <- df_cond4 %>% 
  data.preprocessing() %>% 
  mutate(
    condition = "cond4"
  )

```


```{r}
#creating combined, filetered dataframes

cond1_filtered <- df_preprocessed_cond1 %>% 
  filter(
    ticks > 2911
  )

cond2_filtered <- df_preprocessed_cond2 %>% 
  filter(
    ticks > 2911
  )

cond1_cond2_combined <- rbind(cond1_filtered, cond2_filtered)


cond3_filtered <- df_preprocessed_cond3 %>% 
  filter(
    ticks > 2911
  )

cond4_filtered <- df_preprocessed_cond4 %>% 
  filter(
    ticks > 2911
  )

cond3_cond4_combined <- rbind(cond3_filtered, cond4_filtered)
```

Checking t-test assumptions:

```{r}

#first, remove outliers from the whole data (everything 3 sd away from the mean) - wait until I have more data collected
#calculate z score
#data$rt_z = (data$Reaction_Time -mean(data$Reaction_Time))/sd(data$Reaction_Time)

#filter data 
#no_outliers = data %>% filter(rt_z > -3 & rt_z < 3) 

#subsetting data
#cond1 <- no_outliers %>% filter(ID == 1)
#cond2 <- no_outliers %>% filter(ID == 2)

############ Checking Assumptions for Condition 1
#histogram
ggplot(cond1_filtered, aes(x = polarization_index)) +
  geom_histogram(aes(y = ..density..), binwidth = 0.1) +
  ggtitle("Distribution of polarization index in Condition 1") +
  stat_function(fun = dnorm, args = list(mean = mean(cond1_filtered$polarization_index, na.rm = TRUE), sd = sd(cond1_filtered$polarization_index, na.rm = TRUE)), colour = "darkgreen", size = 1) +
  theme_minimal()

#qqplot
ggplot(cond1_filtered, aes(sample = polarization_index)) +
  stat_qq() +
  stat_qq_line(colour = 'red') +
  ggtitle("Qqplot for polarization index in Condition 1") +
  theme_minimal()



############ Checking Assumptions for Condition 2
#histogram
ggplot(cond2_filtered, aes(x = polarization_index)) +
  geom_histogram(aes(y = ..density..), binwidth = 0.05) +
  ggtitle("Distribution of polarization index in Condition 2") +
  stat_function(fun = dnorm, args = list(mean = mean(cond2_filtered$polarization_index, na.rm = TRUE), sd = sd(cond2_filtered$polarization_index, na.rm = TRUE)), colour = "darkgreen", size = 1) +
  theme_minimal()

#qqplot
ggplot(cond2_filtered, aes(sample = polarization_index )) +
  stat_qq() +
  stat_qq_line(colour = 'red') +
  ggtitle("Qqplot for polarization index in Condition 2") +
  theme_minimal()

#stat.desc
round(pastecs::stat.desc(cbind(cond1_filtered$polarization_index, cond2_filtered$polarization_index), basic = FALSE, norm = TRUE), digits = 2)


```

```{r}
# checking how transforming the data would affect the distribution (log and reciproke)
cond1_filtered <- cond1_filtered %>% 
  mutate(pi_log = log(polarization_index),
         pi_sqrt = sqrt(polarization_index),
         pi_rec = 1/polarization_index)

cond2_filtered <- cond2_filtered %>% 
  mutate(pi_log = log(polarization_index),
         pi_sqrt = sqrt(polarization_index),
         pi_rec = 1/polarization_index)



#stat.desc 
round(pastecs::stat.desc(cbind(cond1_filtered$pi_log, cond1_filtered$pi_sqrt, cond1_filtered$pi_rec), basic = FALSE, norm = TRUE), digits = 2)

round(pastecs::stat.desc(cbind(cond2_filtered$pi_log, cond2_filtered$pi_sqrt, cond2_filtered$pi_rec), basic = FALSE, norm = TRUE), digits = 2)

#normally log transformation is the best here, but there isn't much data, so reciprocal transformation seems to fit it better

#Check assumptions again
############ Checking Assumptions for Condition 1 (best candidates: log and rec)
#histogram
ggplot(cond1_filtered, aes(x = pi_log)) +
  geom_histogram(aes(y = ..density..), binwidth = 0.25) +
  ggtitle("Distribution of polarization index (log transformed) in Condition 1") +
  stat_function(fun = dnorm, args = list(mean = mean(cond1_filtered$pi_log, na.rm = TRUE), sd = sd(cond1_filtered$pi_log, na.rm = TRUE)), colour = "darkgreen", size = 1) +
  theme_minimal()

#qqplot
ggplot(cond1_filtered, aes(sample = pi_log )) +
  stat_qq() +
  stat_qq_line(colour = 'red') +
  ggtitle("Qqplot for polarization index (log transformed) in Condition 1") +
  theme_minimal()

#histogram
ggplot(cond1_filtered, aes(x = pi_rec)) +
  geom_histogram(aes(y = ..density..), binwidth = 0.25) +
  ggtitle("Distribution of polarization index (reciprocal transformed) in Condition 1") +
  stat_function(fun = dnorm, args = list(mean = mean(cond1_filtered$pi_rec, na.rm = TRUE), sd = sd(cond1_filtered$pi_rec, na.rm = TRUE)), colour = "darkgreen", size = 1) +
  theme_minimal()

#qqplot
ggplot(cond1_filtered, aes(sample = pi_rec )) +
  stat_qq() +
  stat_qq_line(colour = 'red') +
  ggtitle("Qqplot for reading time data (reciprocal transformed) in Condition 1") +
  theme_minimal()



############ Checking Assumptions for Condition 2 (best candidates: log and rec)
#histogram
ggplot(cond2_filtered, aes(x = pi_log)) +
  geom_histogram(aes(y = ..density..), binwidth = 0.25) +
  ggtitle("Distribution of polarization index (log transformed) in Condition 2") +
  stat_function(fun = dnorm, args = list(mean = mean(cond2_filtered$pi_log, na.rm = TRUE), sd = sd(cond2_filtered$pi_log, na.rm = TRUE)), colour = "darkgreen", size = 1) +
  theme_minimal()

#qqplot
ggplot(cond2_filtered, aes(sample = pi_log )) +
  stat_qq() +
  stat_qq_line(colour = 'red') +
  ggtitle("Qqplot for reading time data (log transformed) in Condition 2") +
  theme_minimal()


#histogram
ggplot(cond2_filtered, aes(x = pi_rec)) +
  geom_histogram(aes(y = ..density..), binwidth = 0.25) +
  ggtitle("Distribution of polarization index (reciprocal transformed) in Condition 2") +
  stat_function(fun = dnorm, args = list(mean = mean(cond2_filtered$pi_rec, na.rm = TRUE), sd = sd(cond2_filtered$pi_rec, na.rm = TRUE)), colour = "darkgreen", size = 1) +
  theme_minimal()

#qqplot
ggplot(cond2_filtered, aes(sample = pi_rec )) +
  stat_qq() +
  stat_qq_line(colour = 'red') +
  ggtitle("Qqplot for reading time data (reciprocal transformed) in Condition 2") +
  theme_minimal()


## the transofrmations made the data worse, so we will not transform it 

```




Running t-tests

DECIDE: which t test to use?

```{r}
t.test(polarization_index ~ condition, data = cond1_cond2_combined)

WRS2::yuen(cond1_cond2_combined$polarization_index ~ cond1_cond2_combined$condition, data = cond1_cond2_combined)


t.test(polarization_index ~ condition, data = cond3_cond4_combined)

WRS2::yuen(cond3_cond4_combined$polarization_index ~ cond3_cond4_combined$condition, data = cond3_cond4_combined)
```

```{r}
# visualizing outcomes

cond1_cond2_combined$condition <- as.factor(cond1_cond2_combined$condition)

ggplot(cond1_cond2_combined, aes(x = condition, y = polarization_index, colour = condition)) +
  theme_minimal() +
  labs(x = "Condition", y = "Polarization index") +
  geom_boxplot(width = 0.5) +
  ggtitle("Box Plot: polarization index depending on condition")




cond3_cond4_combined$condition <- as.factor(cond3_cond4_combined$condition)

ggplot(cond3_cond4_combined, aes(x = condition, y = polarization_index, colour = condition)) +
  theme_minimal() +
  labs(x = "Condition", y = "Polarization index") +
  geom_boxplot(width = 0.5) +
  ggtitle("Box Plot: polarization index depending on condition")

```

Report Example: *Using an independent t-test, we found that the unexpected word did not significantly increase the average reading time of a word, t(7.66) = 0.46, p > .05, r = 0.16, (M exp = 0.45, M unexp = 0.49)*




```{r}
total_summary_data <- rbind(summary_cond1_cond2, summary_cond3_cond4, summary_cond5_cond6)

theme_set(
  theme_bw() +
    theme(legend.position = "right")
  )

mean_plot <- total_summary_data %>% 
  ggplot(aes(x = ticks, y = mean_opinion_global, color = condition)) +
  geom_point(size = 0.3) +
  labs (title = "Mean opinion in all conditions", x = "Ticks", y = "Mean Opinion") +
  ylim(-1, 1)
mean_plot


var_plot <- total_summary_data %>% 
  ggplot(aes(x = ticks, y = var_opinion_global, color = condition)) +
  geom_point(size = 0.3) +
  labs (title = "Variance of opinion in all conditions", x = "Ticks", y = "Variance") +
  ylim(0, 1)


sd_plot <- total_summary_data %>% 
  ggplot(aes(x = ticks, y = sd_opinion_global, color = condition)) +
  geom_point(size = 0.3) +
  labs (title = "Standard dev. of opinion in all conditions", x = "Ticks", y = "SD") +
  ylim(0, 1)


pol_index_plot <- total_summary_data %>% 
  ggplot(aes(x = ticks, y = polarization_index, color = condition)) +
  geom_point(size = 0.3) +
  labs (title = "Mean polarization index in all conditions", x = "Ticks", y = "Polarization Index") +
  ylim(0, 1)
pol_index_plot



total_summary_data_1to4<- rbind(summary_cond1_cond2, summary_cond3_cond4)

pol_index_plot_1to4 <-total_summary_data_1to4 %>% 
  ggplot(aes(x = ticks, y = polarization_index, color = condition)) +
  geom_point(size = 0.3) +
  labs (title = "Mean polarization index in all conditions", x = "Ticks", y = "Polarization Index") +
  ylim(0, 1) +
  theme(legend.title = element_text(size = 14),
          legend.text = element_text(size = 12))+
  theme_minimal()

pol_index_plot_1to4


figure <- ggarrange(mean_plot, var_plot, sd_plot, pol_index_plot,
    #                labels = c("A", "B", "C"),
                    ncol = 2, nrow = 2,
                    font.label = list(size = 16, color = "black", face = "bold", family = NULL),
                    legend = "right",
                    common.legend = TRUE)
figure
```


```{r}
